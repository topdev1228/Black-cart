#!/bin/sh
set -e

# prefer user supplied CFLAGS, but default to our PHP_CFLAGS
: ${CFLAGS:=$PHP_CFLAGS}
: ${CPPFLAGS:=$PHP_CPPFLAGS}
: ${LDFLAGS:=$PHP_LDFLAGS}
export CFLAGS CPPFLAGS LDFLAGS

usage() {
  echo "usage: $0 cmd"
  echo "   ie: $0 /usr/local/bin/datadog-setup.php"
}

if [ $1 == "--help" ]; then
  usage
  exit 0
fi

srcExists=
if [ -d /usr/src/php ]; then
  srcExists=1
fi
docker-php-source extract

pm='unknown'
if [ -e /lib/apk/db/installed ]; then
  pm='apk'
fi

apkDel=
if [ "$pm" = 'apk' ]; then
  if [ -n "$PHPIZE_DEPS" ]; then
    if apk info --installed .phpize-deps-configure > /dev/null; then
      apkDel='.phpize-deps-configure'
    elif ! apk info --installed .phpize-deps > /dev/null; then
      apk add --no-cache --virtual .phpize-deps $PHPIZE_DEPS
      apkDel='.phpize-deps'
    fi
  fi
fi

popDir="$PWD"

eval $@

if [ "$pm" = 'apk' ] && [ -n "$apkDel" ]; then
  apk del --no-network $apkDel
fi

if [ -e /usr/src/php/.docker-delete-me ]; then
  docker-php-source delete
fi
